#!/bin/sh

usage () {
cat <<USAGE_END
Usage:
    $0 [-s HIGH] [-c LOW | -k] [-m N] cmd
    $0 [-s HIGH] [-c LOW | -k] [-m N] -p pid
    $0 -h
USAGE_END
}

opt_hi="2.5"    # high load
opt_lo="1.5"    # low load
opt_kill=0      # kill
opt_monitor=30  # monitor this often
opt_pid=""      # other pid

while getopts 'c:hkm:p:s:' opt; do
    case $opt in
        c)  opt_lo="$OPTARG"        ;;
        h)  usage; exit 0           ;;
        k)  opt_kill=1              ;;
        m)  opt_monitor="$OPTARG"   ;;
        p)  opt_pid="$OPTARG"       ;;
        s)  opt_hi="$OPTARG"        ;;
        *)  usage; exit 1           ;;
    esac
done

shift $(( OPTIND - 1 ))

cmd="$1"

if [ -z "$cmd" ] && [ -z "$opt_pid" ]; then
    echo 'Expected "cmd" or "-p pid"'
    usage
    exit 1
elif [ -z "$opt_pid" ]; then
    $cmd &
    cmd_pid=$!
else
    cmd_pid="$opt_pid"
fi

while true; do
    if ! is_running "$cmd_pid"; then
        exit 0
    fi

    sleep "$opt_monitor"
done
